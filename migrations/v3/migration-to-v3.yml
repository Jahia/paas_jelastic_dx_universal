---
type: update
version: 1.5.2
name: Migrate Jahia env to v3
id: migrate-jahia-env-v3

# Required for healthchecks
mixins:
  - "../../common/common_actions.yml"
  - "../../jahia/jahia_actions.yml"
  - "../../database/mariadb_actions.yml"
  - "../../database/galera_actions.yml"
  - "../../haproxy/haproxy_actions.yml"

globals:
  version: 3

onInstall:
  ### Pre-checks
  - checkEnvVersion: ${globals.version}
  - checkJahiaHealth: "cp, proc"
  - checkHaproxyHealth: bl
  - checkMariadbHealth: sqldb
  - checkGaleraClusterHealth: sqldb

  - installStrongswan # PAAS-1207
  - checkProductVersion # PAAS-1342

  ### Post-actions
  - eventsUpdate # PAAS-1322
  - setEnvVersion: ${globals.version}
  - checkJahiaHealth: "cp, proc"
  - checkHaproxyHealth: bl
  - checkMariadbHealth: sqldb
  - checkGaleraClusterHealth: sqldb

actions:
  eventsUpdate:
    install:
      jps: "${baseUrl}/../../update.yml"

  installStrongswan:
    - cmd [cp, proc]: |-
        if ! rpm --quiet -q strongswan; then
          echo "[INFO] Installing Strongswan"
          yum install -y strongswan && systemctl disable strongswan
          exit $?
        fi
        echo "[INFO] Strongswan already installed, nothing to do"
      user: root

  checkProductVersion:
    - api [${nodes.cp.first.id}]: environment.control.GetNodeInfo
    - setGlobals:
        jahiaVersion: ${response.node.version}
    - script: |
        const envName = "${env.envName}";
        const targetJahiaVersion = "${globals.jahiaVersion}";
        currentJahiaVersion = jelastic.env.control.GetNodeGroups(envName, session).object.filter(function (object) {
                                        return object.name == "cp";
                                      }).pop().productVersion;
        if (currentJahiaVersion == targetJahiaVersion) {
          return {"result": 0, "out": "cp NodeGroup data has the correct Jahia version"};
        }
        resp = jelastic.env.control.ApplyNodeGroupData(envName, session, nodeGroup='cp', data={'productVersion': targetJahiaVersion});
        return {"result": 0, "out": "Jahia version has been updated on cp NodeGroup data"};
