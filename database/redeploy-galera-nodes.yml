---
type: update
version: 1.5.2
name: Jahia - Redeploy Galera nodes
logo: /images/jahia-logo-70x70.png
id: redeploy-galera-nodes

globals:
  targetDockerTag: ${settings.targetDockerTag}

mixins:
  - galera_actions.yml
  - ../jahia/jahia_actions.yml

onInstall:
  - enableFullReadOnlyOnCluster
  - redeployGalera
  - disableFullReadOnlyOnCluster

actions:
  redeployGalera:
    forEach(nodes.sqldb):
      - log: "Redeploying MariaDB on node ${@i.id}..."
      - stopGalera: ${@i.id}
      - api: environment.control.RedeployContainerById
        nodeId: ${@i.id}
        tag: ${globals.targetDockerTag}
        useExistingVolumes: true
        skipReinstall: false
        envName: ${env.envName}

settings:
  fields:
    - name: targetDockerTag
      type: dockertags
      nodeType: mariadb-dockerized
      caption: MariaDB target Docker tag
      default: 10.4.13
      required: false
